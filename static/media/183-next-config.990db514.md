---
title: "Embed Express into Next-js"
date: 2023-09-24
id: blog0183
tag: nextjs express react
intro: "We study the structure of the project and appropriate ts-config.json configuration to make everything works in typescript."
toc: true
---

#### Project Structure

Add `server/app.ts` in the root directory with the following content:

```js
import express from "express";
import next from "next";
import configRoutes from "./configRoutes";

const port = process.env.PORT || 3001;
const dev = process.env.NODE_ENV !== "production";
const nextApp = next({ dev });
const handle = nextApp.getRequestHandler();

nextApp.prepare().then(() => {
  const server = express();

  server.get("*", (req, res) => {
    return handle(req, res);
  });

  server.listen(port, () => {
    console.log(`Read ony ${port}`);
  });
});
```

We replace our `"dev"` script in `package.json` by

```text
"dev": "env-cmd -f .env-cmdrc.json -e default,env ts-node server/app.ts",
```

Error will immediately occur and we need to modify our `tsconfig.json`:

#### New `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "esnext",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "strict": true,
    "noImplicitAny": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve"
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", "server/app.ts"],
  "exclude": ["node_modules"],
  "ts-node": {
    "compilerOptions": {
      "module": "commonjs"
    }
  },
  "typeRoots": ["./node_modules/@types", "./types"]
}
```

Compared to the original `tsconfig.json` generated by the next project, we have modified:

- `compilerOptions.target = esnext` (from `commonjs`)
- `"ts-node"` is added

Now we can configure our routes by `server.get("/api/test")`, as long as it is exeucuted **_before_** `server.get("*")` as unmatched routes will fallback to the final middleware, the `handle`.

#### Reference

- [Adding Express Back end to Next JS - Next JS Tutorial Part 3](https://www.youtube.com/watch?v=kmrJkrW-ha0&t=977s)
- [How do you run TypeScript files used in a Next.js project, outside of Next.js?](https://github.com/vercel/next.js/discussions/39842)
